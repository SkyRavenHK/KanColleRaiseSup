<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script type="text/javascript" language="javascript" src="devtools.js"></script>
<script type="text/javascript" language="javascript">
function parse_input() {
	var f_damage_total = 0;
	var f_hp_total = 0;
	var f_lost_count = 0;
	var f_count = 0;
	var e_damage_total = 0;
	var e_hp_total = 0;
	var e_count = 0;
	var e_lost_count = 0;
	var e_leader_lost = false;
	var isChase = false;
	var f_maxhp_total = 0;
	// guess_win_rank()を抜き出して、guess_win_rank2()を作成する.
	var s = guess_win_rank.toString().replace(/^function[\s\S]+%%% CUT HERE FOR TEST %%%/, "function guess_win_rank2() {");
	eval(s);
	// 入力を解析する.
	var state = '';
	var enemy = '';
	var match = null;
	var output = [];
	var input = document.fm.input.value.split('\n');
	input.forEach(function(s) {
		// f_damage_total, f_hp_total, f_lost_count, f_count,
		// e_damage_total, e_hp_total, e_lost_count, e_count, e_leader_lost
		if (match = /^勝敗推定:(完?[SA-E])/.exec(s)) {
			state = 'g';
			g_rank = match[1];
		}
		else if (/^friend damage/.test(s)) {
			state = 'f';
			f_count = f_lost_count = f_maxhp_total = 0;
		}
		else if (/^enemy damage/.test(s)) {
			state = 'e';
			e_count = e_lost_count = 0; e_leader_lost = false;
		}
		else if (/^battle result/.test(s)) {
			state = 'r';
		}
		else if (state == 'f' && /^[1-6]\(/.test(s)) {
			++f_count;
			if (match = / \d+\/(\d+)/.exec(s)) { f_maxhp_total += parseInt(match[1]); }
			if (/:撃沈/.test(s)) { ++f_lost_count; }
		}
		else if (state == 'e' && /^[1-6]\(/.test(s)) {
			++e_count;
			if (/:撃沈/.test(s)) { ++e_lost_count; if(/^1/.test(s)) e_leader_lost = true; }
		}
		else if (state == 'r' && (match = /\(\d\/\d\):(完?[SA-E])/.exec(s))) {
			r_rank = match[1];
		}
		else if (/f_damage:/.test(s)) {
			// [html] f_damage:8/30(27%)[0/1], e_damage:20/73(27%)[1/3], rate:1.1 => rank:C, old-guess:D, new-guess:C
			if (match = /=> rank:(完?[SA-E]), old-guess:(完?[SA-E])/.exec(s)) {
				r_rank = match[1];
				g_rank = match[2];
			}
			// [LOGBOOK] 1-1-3(boss):8, f_damage:5/40(13%)[0/1]40, e_damage:26/77(34%)[1/3], chase_rate:2.7, rank:B
			// [LOGBOOK] 1-1-3(boss):8, f_damage:5/40(13%)[0/1]40, e_damage:26/77(34%)[1/3], chase_rate:2.7, rank:B/C MISS!!
			if (match = /, rank:(完?[SA-E])(\/)?(完?[SA-E])?/.exec(s)) {
				r_rank = match[1];
				g_rank = match[3] ? match[3] : match[1];
				isChase = /chase_rate/.test(s);
			}
			// [old-LOGBOOK] 演習相手:xxx, B/B, f_damage:3/103(3%)[0/6], e_damage:191/317(60%)[3/6], rate:20.7
			if (match = /, (完?[SA-E])\/(完?[SA-E]), f_damage:/.exec(s)) {
				r_rank = match[1];
				g_rank = match[2];
			}
			// 勝敗推定ミス f_damage:5/42(12%), e_damage:22/77(29%)
			if (match = /f_damage:(\d+)\/(\d+)/.exec(s)) {
				f_damage_total = match[1]; f_hp_total = match[2];
			}
			if (match = /e_damage:(\d+)\/(\d+)/.exec(s)) {
				e_damage_total = match[1]; e_hp_total = match[2];
			}
			// 緒戦被害:f_damage:48/111(44%)[0/4], e_damage:138/289(48%)[1/5], rate:1.1, 推定:C
			// 戦闘被害:f_damage:52/111(47%)[0/4], e_damage:196/289(68%)[1/5], chase_rate:1.5
			// 勝敗推定ミス f_damage:54/201(27%)[0/6]210, e_damage:217/321(68%)[3/6], rate:2.5
			if (match = /f_damage:(\d+)\/(\d+)\(\d+\%\)\[(\d+)\/(\d+)\](\d+)?/.exec(s)) {
				f_damage_total = match[1]; f_hp_total = match[2]; f_lost_count = match[3]; f_count = match[4];
				f_maxhp_total = match[5];
				isChase = /chase_rate/.test(s);
			}
			if (match = /e_damage:(\d+)\/(\d+).\d+\%.\[(\x?)(\d+)\/(\d+)\]/.exec(s)) {
				e_damage_total = match[1]; e_hp_total = match[2]; e_lost_count = match[4]; e_count = match[5];
				e_leader_lost = (match[3] == 'x');
			}
		}
		if (/(勝敗推定ミス f_damage:|, f_damage:|=> rank:|^MVP:)/.test(s) && r_rank) {
			if (!f_maxhp_total) f_maxhp_total = ""; // undefined or 0.
			var g_rank2 = guess_win_rank2();
			var msg = r_rank + ', old-guess:' + g_rank + ', new-guess:' + g_rank2;
			if (r_rank != g_rank2) msg += ' MISS!!';
			output.push($guess_info_str + ' => rank:' + msg);
			r_rank = g_rank = g_rank2 = undefined;
			isChase = false;
		}
	});
	var result = document.getElementById('result');
	result.textContent = output.join('\n');
//	result.innerHTML = input;
}
</script>
</head>

<body>
<h1>YPS 勝敗推定検算</h1>
<h2>戦闘ログ</h2>
<form name="fm">
<textarea name="input" rows="20" cols="100">
2015/3/17 2:18:49
鎮守府正面海域 battle2

1-1-3(boss):8
単縦/同航/単縦
索敵: なし
制空権確保
勝敗推定:C
friend damage
第1艦隊
1(あきつ丸改Lv73). 36/40:.
2(まるゆLv11). 1/6(-5):大破!!!
被撃墜数: 0
enemy damage
1(軽巡ホ級Lv1). 33/33:*
2(駆逐ロ級Lv1). 0/22(-68):撃沈---
3(駆逐ロ級Lv1). 22/22:*
battle result
敵主力艦隊(1/3):B
勝敗推定ミス f_damage:5/42(12%), e_damage:22/77(29%)
MVP: あきつ丸改Lv73 +90exp
drop ship
駆逐艦:曙
</textarea>
<input type="button" value="検算" onclick="parse_input()"></input>
</form>
<h2>検算結果</h2>
<pre><div id="result">結果</div></pre>
</body>
</html>
